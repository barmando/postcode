<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PC4 Layer Viewer (Leaflet) – plak je WFS/GeoJSON URLs</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    header { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: space-between; }
    header h1 { font-size: 16px; margin: 0; }
    .controls { display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 12px 16px; border-bottom: 1px solid #e5e7eb; }
    .controls textarea { width: 100%; height: 140px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 10px; }
    .controls .buttons { display: flex; flex-direction: column; gap: 8px; }
    button { padding: 10px 12px; border: 1px solid #d1d5db; background: #111827; color: white; border-radius: 10px; cursor: pointer; }
    button.secondary { background: white; color: #111827; }
    #map { height: 72vh; }
    .legend { position: absolute; bottom: 16px; left: 16px; background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 8px 10px; font-size: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.08); }
    .legend-item { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .swatch { width: 14px; height: 14px; border-radius: 4px; border: 1px solid #9ca3af; }
    .hint { color: #6b7280; font-size: 12px; margin: 6px 0 0; }
    .footer { padding: 8px 16px; color: #6b7280; font-size: 12px; border-top: 1px solid #e5e7eb; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>PC4 Layer Viewer – plak PDOK/uMap GeoJSON URLs</h1>
      <div class="hint">Formaat per regel: <code>kleurHEX|label|url</code> (pijpbalkjes)</div>
    </header>

    <section class="controls">
      <textarea id="input" spellcheck="false"></textarea>
      <div class="buttons">
        <button id="load">Laad lagen</button>
        <button id="share" class="secondary">Deelbare link</button>
        <button id="clear" class="secondary">Reset</button>
      </div>
      <div class="hint" style="grid-column: 1 / -1;">
        Voorbeeldregels met jouw 5 gemeenten staan alvast ingevuld. Je kunt nieuwe regels toevoegen of bestaande aanpassen.
      </div>
    </section>

    <div style="padding: 0 16px 8px; display:flex; gap:8px; align-items:center">
      <label><input type="checkbox" id="useProxy"> Gebruik proxy (alleen als CORS faalt)</label>
      <input id="proxyBase" placeholder="https://cors.isomorphic-git.org/" style="flex:1; padding:6px 8px; border:1px solid #e5e7eb; border-radius:10px"/>
    </div>

    <div id="map"></div>
    <div class="footer">Let op: dit werkt alleen als de bronserver CORS toestaat (PDOK meestal wel). Als je niets ziet: probeer de proxy-optie hieronder of open dit bestand lokaal in een eigen browservenster. Anders heb je een proxy nodig, of gebruik uMap met de Proxy-optie.</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const map = L.map('map');
    map.setView([52.1, 5.3], 7); // start in NL zodat je altijd de tegelkaart ziet
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let layers = [];

    function parseLines(text) {
      return text.split(/\n+/).map(l => l.trim()).filter(Boolean).map(l => {
        // Expect: #hex|label|url
        const [color, label, url] = l.split('|');
        return { color: color?.trim(), label: label?.trim(), url: url?.trim() };
      });
    }

    function clearLayers() {
      layers.forEach(obj => map.removeLayer(obj.layer));
      layers = [];
      const legend = document.querySelector('.legend');
      legend && legend.remove();
    }

    async function addLayer({color, label, url}) {
      // Optional proxy
      const useProxy = document.getElementById('useProxy').checked;
      const proxyBase = document.getElementById('proxyBase').value || '';
      const finalURL = useProxy && proxyBase ? proxyBase + encodeURIComponent(url) : url;

      const res = await fetch(finalURL);
      if (!res.ok) throw new Error('Kon niet laden: ' + finalURL + ' (' + res.status + ')');
      const geo = await res.json();

      const style = { color: color || '#111827', weight: 1, fillColor: color || '#111827', fillOpacity: 0.5 };

      const gj = L.geoJSON(geo, {
        style,
        onEachFeature: (feature, layer) => {
          const pc = feature?.properties?.pc4 ?? feature?.properties?.PC4 ?? '';
          const name = label || 'Laag';
          layer.bindPopup(`<b>${name}</b><br>PC4: ${pc}`);
        }
      }).addTo(map);

      layers.push({layer: gj, color, label});
    };

      const gj = L.geoJSON(geo, {
        style,
        onEachFeature: (feature, layer) => {
          const pc = feature?.properties?.pc4 ?? feature?.properties?.PC4 ?? '';
          const name = label || 'Laag';
          layer.bindPopup(`<b>${name}</b><br>PC4: ${pc}`);
        }
      }).addTo(map);

      layers.push({layer: gj, color, label});
    }

    function fitAll() {
      const group = L.featureGroup(layers.map(o => o.layer));
      try { map.fitBounds(group.getBounds(), { padding: [20,20] }); }
      catch(e) { map.setView([52.1, 5.3], 8); }
    }

    function renderLegend() {
      const div = document.createElement('div');
      div.className = 'legend';
      div.innerHTML = layers.map(o => `
        <div class="legend-item">
          <span class="swatch" style="background:${o.color}"></span>
          <span>${o.label || 'Laag'}</span>
        </div>
      `).join('');
      document.body.appendChild(div);
    }

    async function loadFromTextarea() {
      clearLayers();
      const lines = parseLines(document.getElementById('input').value);
      for (const line of lines) {
        if (!line.url) continue;
        await addLayer(line); // sequential to avoid rate spikes
      }
      if (layers.length) {
        fitAll();
        renderLegend();
      }
    }

    function serializeToHash() {
      const text = document.getElementById('input').value;
      const encoded = encodeURIComponent(text);
      location.hash = 'cfg=' + encoded;
      return location.href;
    }

    function restoreFromHash() {
      const m = location.hash.match(/cfg=([^&]+)/);
      if (m) {
        const decoded = decodeURIComponent(m[1]);
        document.getElementById('input').value = decoded;
      }
    }

    // Defaults: 5 gemeenten met jouw URLs en kleuren
    const defaults = [
      "#1f77b4|Altena|https://service.pdok.nl/cbs/postcode4/2024/wfs/v1_0?service=WFS&request=GetFeature&typeNames=cbs:postcode4&version=2.0.0&srsName=EPSG:4326&outputFormat=json&CQL_FILTER=pc4%20IN%20('4250','4251','4252','4253','4254','4255','4260','4261','4262','4263','4264','4265','4266','4267','4268','4269','4270','4271','4272','4273','4280','4281','4282','4283','4284','4285','4286','4287','4288')",
      "#2ca02c|Waalwijk|https://service.pdok.nl/cbs/postcode4/2024/wfs/v1_0?service=WFS&request=GetFeature&typeNames=cbs:postcode4&version=2.0.0&srsName=EPSG:4326&outputFormat=json&CQL_FILTER=pc4%20IN%20('5141','5142','5143','5144','5145','5146','5147','5148','5149')",
      "#ff7f0e|Heusden|https://service.pdok.nl/cbs/postcode4/2024/wfs/v1_0?service=WFS&request=GetFeature&typeNames=cbs:postcode4&version=2.0.0&srsName=EPSG:4326&outputFormat=json&CQL_FILTER=pc4%20IN%20('5150','5151','5152','5153','5154','5250','5251','5252','5253','5254','5255','5256')",
      "#9467bd|Loon op Zand|https://service.pdok.nl/cbs/postcode4/2024/wfs/v1_0?service=WFS&request=GetFeature&typeNames=cbs:postcode4&version=2.0.0&srsName=EPSG:4326&outputFormat=json&CQL_FILTER=pc4%20IN%20('5170','5171','5172','5173','5174','5175','5176')",
      "#d62728|Dongen|https://service.pdok.nl/cbs/postcode4/2024/wfs/v1_0?service=WFS&request=GetFeature&typeNames=cbs:postcode4&version=2.0.0&srsName=EPSG:4326&outputFormat=json&CQL_FILTER=pc4%20IN%20('5100','5101','5102','5103','5104','5105','5106','5107','5108','5109')"
    ].join("\n");

    document.getElementById('input').value = defaults;
    restoreFromHash();

    document.getElementById('load').addEventListener('click', async () => {
      try { await loadFromTextarea(); }
      catch (e) { alert(e.message + '\n\nTip: vink "Gebruik proxy" aan/uit en probeer opnieuw. Je kunt de URL ook direct in een nieuw tabblad openen om te testen.'); }
    });
    document.getElementById('share').addEventListener('click', () => {
      const url = serializeToHash();
      alert('Deel deze link om dezelfde configuratie te openen:\n\n' + url);
    });
    document.getElementById('clear').addEventListener('click', () => {
      document.getElementById('input').value = '';
      clearLayers();
    });

    // Eerste render met defaults
    loadFromTextarea();
  </script>
</body>
</html>
