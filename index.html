<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Postcodezones (PC4) – Altena, Waalwijk, Heusden, Loon op Zand, Dongen</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .panel { position: absolute; z-index: 1000; left: 12px; top: 12px; background: rgba(255,255,255,0.95); border: 1px solid #e5e7eb; border-radius: 14px; padding: 12px 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .panel h1 { font-size: 16px; margin: 0 0 6px; }
    .panel p { margin: 0 0 8px; font-size: 13px; color: #4b5563; }
    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; margin: 6px 0; }
    .dot { width: 10px; height: 10px; border-radius: 50%; flex: 0 0 10px; }
    .footer { position: absolute; right: 12px; bottom: 12px; z-index: 1000; background: rgba(255,255,255,0.95); border: 1px solid #e5e7eb; border-radius: 999px; padding: 6px 10px; font-size: 12px; color: #4b5563; }
    .controls { margin-top: 8px; border-top: 1px solid #e5e7eb; padding-top: 8px; }
    .controls label { display: flex; align-items: center; gap: 8px; font-size: 13px; margin: 4px 0; cursor: pointer; }
    .note { font-size: 11px; color: #6b7280; margin-top: 8px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h1>Postcodezones (PC4)</h1>
    <p>Dit zijn echte PC4-polygonen uit een GeoJSON-bestand. Vink aan/uit om te tonen/verbergen.</p>
    <div id="legend"></div>
    <div class="controls" id="controls"></div>
    <div class="note">NB: "Loop op Zand" is geïnterpreteerd als <strong>Loon op Zand</strong>.</div>
  </div>

  <div class="footer">© OpenStreetMap contributors</div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // ===== 1) Configuratie van de zones per gemeente (als PC4-ranges) =====
    const ZONE_RANGES = {
      'Altena':       ['4250-4255', '4260-4269', '4270-4273', '4280-4288'],
      'Waalwijk':     ['5141-5149'],
      'Heusden':      ['5150-5154', '5250-5256'],
      'Loon op Zand': ['5170-5176'],
      'Dongen':       ['5100-5109']
    };

    // Kleuren per gemeente
    const COLORS = {
      'Altena': '#2563eb',
      'Waalwijk': '#16a34a',
      'Heusden': '#e11d48',
      'Loon op Zand': '#9333ea',
      'Dongen': '#f59e0b'
    };

    // ===== 2) Helpers om ranges uit te breiden naar een Set met PC4-codes =====
    const enDash = /\u2013|\u2014|\u2212/g; // streepjes varianten
    function expandRange(rangeStr) {
      const clean = rangeStr.replace(enDash, '-').trim();
      const [a, b] = clean.split('-').map(s => parseInt(s, 10));
      if (Number.isFinite(a) && Number.isFinite(b)) {
        const out = [];
        const start = Math.min(a, b), end = Math.max(a, b);
        for (let v = start; v <= end; v++) out.push(String(v).padStart(4, '0'));
        return out;
      } else {
        return [String(a).padStart(4, '0')];
      }
    }

    function buildPc4Sets(rangesByZone) {
      const map = new Map(); // zone -> Set(pc4)
      Object.entries(rangesByZone).forEach(([zone, ranges]) => {
        const set = new Set();
        ranges.forEach(r => expandRange(r).forEach(pc4 => set.add(pc4)));
        map.set(zone, set);
      });
      return map;
    }

    const PC4SETS = buildPc4Sets(ZONE_RANGES);

    // Snelle lookup: pc4 -> zone (eerste match wint)
    function lookupZone(pc4) {
      for (const [zone, set] of PC4SETS.entries()) {
        if (set.has(pc4)) return zone;
      }
      return null;
    }

    // ===== 3) Leaflet kaart =====
    const map = L.map('map', { scrollWheelZoom: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // UI elementen
    const legendEl = document.getElementById('legend');
    const controlsEl = document.getElementById('controls');

    // ===== 4) GeoJSON laden (vervang bestandsnaam met jouw gedownloade PC4-GeoJSON) =====
    const GEOJSON_URL = 'cbs_postcode4_2024.geojson'; // <-- plaats dit bestand naast deze HTML

    fetch(GEOJSON_URL)
      .then(r => r.json())
      .then(geo => {
        // Bepaal propertynaam voor PC4 (kan pc4 / PC4 / postcode4 zijn)
        function getPc4(props) {
          return String(props.pc4 ?? props.PC4 ?? props.postcode4 ?? '').padStart(4, '0');
        }

        const groupLayers = {}; // zone -> L.GeoJSON laag
        const allBounds = [];

        // Maak een gecombineerde laag, maar style/filter per feature
        const layer = L.geoJSON(geo, {
          filter: f => !!lookupZone(getPc4(f.properties)),
          style: f => {
            const pc4 = getPc4(f.properties);
            const zone = lookupZone(pc4);
            const color = COLORS[zone] || '#555';
            return { color, weight: 1.2, fillOpacity: 0.25, fillColor: color };
          },
          onEachFeature: (f, lyr) => {
            const pc4 = getPc4(f.properties);
            const zone = lookupZone(pc4);
            lyr.bindPopup(`<strong>${zone || 'Onbekend'}</strong><br/>PC4: ${pc4}`);
            allBounds.push(lyr.getBounds());
            // Sorteer features per zone in aparte FeatureGroups zodat je kunt togglen
            if (!groupLayers[zone]) groupLayers[zone] = L.featureGroup();
            lyr.addTo(groupLayers[zone]);
          }
        });

        // Voeg per zone de groep toe en maak toggles + legenda
        Object.keys(ZONE_RANGES).forEach(zone => {
          const grp = groupLayers[zone] || L.featureGroup();
          grp.addTo(map);

          // legenda
          const item = document.createElement('div');
          item.className = 'legend-item';
          item.innerHTML = `<span class="dot" style="background:${COLORS[zone]}"></span><span><strong>${zone}:</strong> ${ZONE_RANGES[zone].join(', ')}</span>`;
          legendEl.appendChild(item);

          // toggle
          const id = `chk-${zone.replace(/\s+/g,'-').toLowerCase()}`;
          const label = document.createElement('label');
          label.innerHTML = `<input id="${id}" type="checkbox" checked /> <span>${zone} tonen</span>`;
          controlsEl.appendChild(label);
          label.querySelector('input').addEventListener('change', (e) => {
            if (e.target.checked) {
              grp.addTo(map);
            } else {
              map.removeLayer(grp);
            }
          });
        });

        // Fit alle polygonen in beeld
        if (allBounds.length) {
          const bounds = allBounds[0].clone();
          for (let i = 1; i < allBounds.length; i++) bounds.extend(allBounds[i]);
          map.fitBounds(bounds.pad(0.1));
        }
      })
      .catch(err => {
        console.error('Kon GeoJSON niet laden:', err);
        alert('Kon PC4 GeoJSON niet laden. Controleer het bestands pad/naam.');
      });
  </script>
</body>
</html>
