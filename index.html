const url = `https://service.pdok.nl/cbs/postcode4/${PDOK_WFS_YEAR}/wfs/v1_0?service=WFS&request=GetFeature&version=2.0.0&typeNames=postcode4&outputFormat=application/json&CQL_FILTER=pc4=${code}`;

lyr.setPopupContent(`PC4: <strong>${code}</strong><br><em>Demografie laden…</em>`);

fetch(url)
  .then(r => r.json())
  .then(j => {
    const props = j?.features?.[0]?.properties || {};
    // Log beschikbaar voor debuggen (F12 → Console)
    console.log('PC4', code, 'velden:', Object.keys(props));

    // Bekende velden (meerdere alias-opties per label)
    const CANDIDATES = [
      ['Inwoners', ['aantal_inwoners','inwoners_totaal','inwoners']],
      ['Huishoudens', ['aantal_huishoudens','huishoudens']],
      ['Bevolkingsdichtheid (/km²)', ['bevolkingsdichtheid','bev_dichtheid']],
      ['Gem. huish. grootte', ['gemiddelde_huishoudensgrootte','huishoudens_gem_grootte']],
      ['0–14 jaar', ['leeftijd_0_14','p_00_14','a_00_14']],
      ['15–24 jaar', ['leeftijd_15_24','p_15_24','a_15_24']],
      ['25–44 jaar', ['leeftijd_25_44','p_25_44','a_25_44']],
      ['45–64 jaar', ['leeftijd_45_64','p_45_64','a_45_64']],
      ['65+ jaar', ['leeftijd_65_plus','p_65_plus','a_65plus']],
      ['Mannen', ['mannen','aantal_mannen']],
      ['Vrouwen', ['vrouwen','aantal_vrouwen']],
    ];

    const pickFirst = (obj, keys) => keys.find(k => obj[k] != null);

    let rows = [];
    for (const [label, keys] of CANDIDATES) {
      const k = pickFirst(props, keys);
      if (k) rows.push(`<tr><td>${label}</td><td style="text-align:right">${props[k]}</td></tr>`);
    }

    // Fallback: als niets van bovenstaand bestaat, toon alle velden (max 20) netjes
    if (rows.length === 0) {
      rows = Object.entries(props)
        .filter(([k]) => !/^geom/i.test(k))          // geometry-veld overslaan
        .slice(0, 20)                                // niet eindeloos
        .map(([k, v]) => {
          // label wat leesbaarder maken
          const label = k.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
          return `<tr><td>${label}</td><td style="text-align:right">${v}</td></tr>`;
        });
    }

    const table = `<table style="width:100%;border-collapse:collapse;font-size:12px">${rows.join('')}</table>`;
    const footer = `<div style="margin-top:6px;color:#6b7280;font-size:11px">Bron: PDOK/CBS Postcode4 ${PDOK_WFS_YEAR} · Opgehaald: ${FETCHED_ON}</div>`;
    lyr.setPopupContent(`PC4: <strong>${code}</strong><br>${table}${footer}`);
  })
  .catch(() => {
    lyr.setPopupContent(`PC4: <strong>${code}</strong><br><em>Live ophalen mislukt</em><div style="margin-top:6px;color:#6b7280;font-size:11px">Dataset: ${DATASET_VERSION} · Opgehaald: ${FETCHED_ON}</div>`);
  });
