<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PC4 – Noord-Brabant (baselayers + filters + live info)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .panel {
      position: absolute; z-index: 1000; left: 12px; top: 12px;
      background: rgba(255,255,255,0.96); border: 1px solid #e5e7eb;
      border-radius: 14px; padding: 12px 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; width: 360px;
    }
    .panel h1 { font-size: 16px; margin: 0 0 6px; }
    .row { display: flex; gap: 8px; align-items: center; margin: 8px 0; }
    .row input[type="text"] { flex: 1; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 10px; }
    .btn { padding: 8px 10px; border: 1px solid #e5e7eb; background: #fff; border-radius: 10px; cursor: pointer; }
    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; margin: 6px 0; }
    .dot { width: 10px; height: 10px; border-radius: 50%; flex: 0 0 10px; }
    .subtle { color:#6b7280; font-size:12px; }
    .footer { position: absolute; right: 12px; bottom: 12px; z-index: 1000; background: rgba(255,255,255,0.95); border: 1px solid #e5e7eb; border-radius: 999px; padding: 6px 10px; font-size: 12px; color: #4b5563; }
    .leaflet-control-layers { font-size: 13px; } /* iets groter voor leesbaarheid */
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h1>Postcode 4 – Noord-Brabant</h1>
    <div class="subtle">Klik een PC4-vlak voor <strong>live info</strong> (PDOK WFS). Gebruik de <em>laag-schakelaar</em> rechtsboven voor basiskaart/labels.</div>

    <div class="row">
      <input id="filterInput" type="text" placeholder="Filter PC4: 51 of 5141, 5170…" />
      <button id="btnFilter" class="btn">Filter</button>
      <button id="btnReset" class="btn">Reset</button>
    </div>
    <div class="subtle">Filter werkt op <em>prefix</em> of lijst (komma/spaties). Bijv. <code>51</code> toont 51xx, <code>5141, 5170</code> toont die twee.</div>

    <div class="legend-item" style="margin-top:10px;"><span class="dot" style="background:#2563eb"></span><span>PC4-polygonen</span></div>
  </div>

  <div class="footer">© OpenStreetMap contributors</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // ---- Basiskaart lagen ----
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });
    const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap, &copy; CARTO'
    });
    const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap, &copy; CARTO'
    });
    // Labels-alleen overlay (bovenop ‘nolabels’-basemaps)
    const cartoLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { pane: 'overlayPane' });

    const map = L.map('map', { scrollWheelZoom: true, layers: [cartoLight, cartoLabels] });

    // Layer switcher rechtsboven
    const baseLayers = {
      'Carto Positron (zonder labels)': cartoLight,
      'Carto Dark Matter (zonder labels)': cartoDark,
      'OpenStreetMap (met labels)': osm
    };
    const overlays = { 'Labels (aan/uit)': cartoLabels };
    L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

    // ---- PC4 GeoJSON + live info ----
    const GEOJSON_URL = 'cbs_postcode4_brabant.geojson';
    const WFS_BASE = 'https://service.pdok.nl/cbs/postcode4/2024/wfs/v1_0';
    const layerStyle = { color: '#2563eb', weight: 1, fillColor: '#2563eb', fillOpacity: 0.15 };

    function fetchLiveFor(pc4code){
      const url = `${WFS_BASE}?service=WFS&request=GetFeature&version=2.0.0&typeNames=postcode4&outputFormat=application/json&CQL_FILTER=pc4=${pc4code}`;
      return fetch(url).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); });
    }
    function renderProps(props){
      const preferred = ['pc4','aantal_inwoners','aantal_mannen','aantal_vrouwen','aantal_huishoudens','bevolkingsdichtheid','opp_totaal'];
      const lines = [];
      preferred.forEach(k=>{ if(props[k] != null) lines.push(`<strong>${k}</strong>: ${props[k]}`); });
      if(!lines.length){
        const entries = Object.entries(props).slice(0,10);
        for(const [k,v] of entries){ lines.push(`<strong>${k}</strong>: ${v}`); }
      }
      return `<div style="font-size:12px;line-height:1.35">${lines.join('<br>')}</div>`;
    }

    let pc4Layer = null;
    const featureIndex = new Map(); // pc4 -> layer (voor filter)

    function getPc4(props){ return (props.pc4 ?? props.PC4 ?? props.postcode4) ?? null; }

    // GeoJSON laden
    fetch(GEOJSON_URL)
      .then(r => { if (!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(data => {
        pc4Layer = L.geoJSON(data, {
          style: layerStyle,
          onEachFeature: (f, lyr) => {
            const code = getPc4(f.properties);
            if(code) featureIndex.set(String(code).padStart(4,'0'), lyr);
            lyr.bindPopup(code ? `PC4: <strong>${code}</strong><br><em>Live gegevens laden…</em>` : 'PC4');
            lyr.on('click', () => {
              if(!code) return;
              lyr.setPopupContent(`PC4: <strong>${code}</strong><br><em>Live gegevens laden…</em>`);
              fetchLiveFor(code)
                .then(json => {
                  const feat = (json && json.features && json.features[0]) || null;
                  const html = feat ? renderProps(feat.properties||{}) : '<em>Geen gegevens gevonden</em>';
                  lyr.setPopupContent(`PC4: <strong>${code}</strong><br>${html}`);
                })
                .catch(err => {
                  console.error('Live ophalen faalde', err);
                  lyr.setPopupContent(`PC4: <strong>${code}</strong><br><em>Live ophalen mislukt</em>`);
                });
            });
          }
        }).addTo(map);
        map.fitBounds(pc4Layer.getBounds().pad(0.05));
      })
      .catch(err => {
        console.error('GeoJSON laden mislukt:', err);
        alert('Kon '+GEOJSON_URL+' niet laden. Controleer bestandsnaam/locatie.');
      });

    // ---- Filter UI (prefix of lijst) ----
    function parseFilter(text){
      const parts = text.split(/[,\s]+/).filter(Boolean).map(s => s.trim());
      // tokens zijn ofwel 2–4 cijferige prefixes of 4-cijferige codes
      return parts.map(t => t.replace(/[–—−]/g,'-'));
    }

    function applyFilter(){
      const tokens = parseFilter(document.getElementById('filterInput').value);
      if(!pc4Layer) return;
      pc4Layer.eachLayer(l => {
        const code = String(getPc4(l.feature.properties)||'').padStart(4,'0');
        let keep = true;
        if(tokens.length){
          keep = tokens.some(t => {
            if(/^\d{4}$/.test(t)) return code === t;     // exacte PC4
            if(/^\d{2,3}$/.test(t)) return code.startsWith(t); // prefix 2–3–4 cijfers
            return false;
          });
        }
        if(keep) { if(!pc4Layer.hasLayer(l)) pc4Layer.addLayer(l); } else { pc4Layer.removeLayer(l); }
      });
    }
    function resetFilter(){
      document.getElementById('filterInput').value = '';
      if(!pc4Layer) return;
      pc4Layer.eachLayer(l => { if(!pc4Layer.hasLayer(l)) pc4Layer.addLayer(l); });
    }

    document.getElementById('btnFilter').addEventListener('click', applyFilter);
    document.getElementById('btnReset').addEventListener('click', resetFilter);

    // Extra: schaalbalk
    L.control.scale({ metric: true, imperial: false }).addTo(map);
  </script>
</body>
</html>
