<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PC4 – Noord‑Brabant (Leaflet + live info + basisscholen)</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .panel { position: absolute; z-index: 1000; left: 12px; top: 12px; background: rgba(255,255,255,0.95); border: 1px solid #e5e7eb; border-radius: 14px; padding: 12px 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .panel h1 { font-size: 16px; margin: 0 0 6px; }
    .panel p { margin: 0 0 8px; font-size: 13px; color: #4b5563; }
    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; margin: 6px 0; }
    .dot { width: 10px; height: 10px; border-radius: 50%; flex: 0 0 10px; }
    .footer { position: absolute; right: 12px; bottom: 12px; z-index: 1000; background: rgba(255,255,255,0.95); border: 1px solid #e5e7eb; border-radius: 999px; padding: 6px 10px; font-size: 12px; color: #4b5563; }
    .small { font-size:12px; color:#6b7280; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h1>Postcode 4 – Noord‑Brabant</h1>
    <p>
      GeoJSON uit <code>cbs_postcode4_brabant.geojson</code>.
      Klik op een PC4‑vlak voor <strong>live info</strong> via PDOK (WFS).
    </p>
    <div class="legend-item"><span class="dot" style="background:#2563eb"></span><span>PC4‑polygonen</span></div>
    <div class="legend-item"><span class="dot" style="background:#10b981"></span><span>Basisscholen (OSM)</span></div>
    <p class="small">Gebruik de laag‑schakelaar rechtsboven om <em>Basisscholen</em> aan/uit te zetten.</p>
  </div>
  </div>

  <div class="footer">© OpenStreetMap contributors</div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // 1) Basiskaart + layers‑control
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' });
    const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap, &copy; CARTO' });
    const map = L.map('map', { scrollWheelZoom: true, layers: [cartoLight] });
    const baseLayers = { 'Carto Positron': cartoLight, 'OpenStreetMap': osm };

    // Overlaylaag voor basisscholen (gevuld na fetch)
    const schoolsLayer = L.layerGroup();
    const overlays = { 'Basisscholen (OSM)': schoolsLayer };
    L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

    // 2) GeoJSON pad (relatief, staat in dezelfde directory als index.html)
    const GEOJSON_URL = 'cbs_postcode4_brabant.geojson';

    // 3) Stijl voor de PC4‑vlakken
    const layerStyle = { color: '#2563eb', weight: 1, fillColor: '#2563eb', fillOpacity: 0.15 }; 

    // 3b) Basisscholen uit OSM (Overpass API)
    let schoolsLoaded = false;
    function fetchSchoolsFor(bounds){
      // bbox in volgorde: zuid,west,noord,oost (Overpass gebruikt: south,west,north,east)
      const b = bounds; // L.LatLngBounds
      const s = b.getSouth(), w = b.getWest(), n = b.getNorth(), e = b.getEast();
      const query = `[
        out:json][timeout:25];(
          node["amenity"="school"]["school:level"~"primary|basisschool",i](${s},${w},${n},${e});
          node["amenity"="school"]["isced:level"~"(^|;|,| )1( |,|;|$)",i](${s},${w},${n},${e});
          node["amenity"="school"]["education"~"primary",i](${s},${w},${n},${e});
          way["amenity"="school"]["school:level"~"primary|basisschool",i](${s},${w},${n},${e});
          way["amenity"="school"]["isced:level"~"(^|;|,| )1( |,|;|$)",i](${s},${w},${n},${e});
          relation["amenity"="school"]["school:level"~"primary|basisschool",i](${s},${w},${n},${e});
        );out center;`;
      const url = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);
      return fetch(url).then(r=>r.json()).then(json => {
        const feats = (json.elements||[]).map(el => {
          const lat = el.lat || (el.center && el.center.lat), lon = el.lon || (el.center && el.center.lon);
          if(lat==null||lon==null) return null;
          const props = el.tags || {}; props.__id = el.id;
          return { type:'Feature', geometry:{ type:'Point', coordinates:[lon,lat] }, properties: props };
        }).filter(Boolean);
        return feats;
      });
    }

    function renderSchools(features){
      schoolsLayer.clearLayers();
      features.forEach(f => {
        const [lon,lat] = f.geometry.coordinates;
        const name = f.properties.name || 'Basisschool';
        const marker = L.circleMarker([lat,lon], { radius: 5, weight: 1, color: '#065f46', fillColor: '#10b981', fillOpacity: 0.8 });
        const addr = [f.properties['addr:street'], f.properties['addr:housenumber'], f.properties['addr:city']].filter(Boolean).join(' ');
        marker.bindPopup(`<strong>${name}</strong><br>${addr}`);
        schoolsLayer.addLayer(marker);
      });
      if(!map.hasLayer(schoolsLayer)) map.addLayer(schoolsLayer);
    } 

    // PDOK WFS endpoint (PC4 2024)
    const WFS_BASE = 'https://service.pdok.nl/cbs/postcode4/2024/wfs/v1_0';
    function fetchLiveFor(pc4code){
      const url = `${WFS_BASE}?service=WFS&request=GetFeature&version=2.0.0&typeNames=postcode4&outputFormat=application/json&CQL_FILTER=pc4=${pc4code}`;
      return fetch(url).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); });
    }
    function renderProps(props){
      const preferred = ['pc4','aantal_inwoners','aantal_mannen','aantal_vrouwen','aantal_huishoudens','bevolkingsdichtheid','opp_totaal'];
      const lines = [];
      preferred.forEach(k=>{ if(props[k] != null) lines.push(`<strong>${k}</strong>: ${props[k]}`); });
      if(!lines.length){
        const entries = Object.entries(props).slice(0,10);
        for(const [k,v] of entries){ lines.push(`<strong>${k}</strong>: ${v}`); }
      }
      return `<div style="font-size:12px;line-height:1.35">${lines.join('<br>')}</div>`;
    }

    // 4) Laden en tonen
    fetch(GEOJSON_URL)
      .then(r => {
        if (!r.ok) throw new Error('HTTP '+r.status);
        return r.json();
      })
      .then(data => {
        const pc4 = L.geoJSON(data, {
          style: layerStyle,
          onEachFeature: (f, lyr) => {
          const code = f.properties.pc4 ?? f.properties.PC4 ?? f.properties.postcode4;
          lyr.bindPopup(code ? `PC4: <strong>${code}</strong><br><em>Live gegevens laden…</em>` : 'PC4');
          lyr.on('click', () => {
            if(!code) return;
            lyr.setPopupContent(`PC4: <strong>${code}</strong><br><em>Live gegevens laden…</em>`);
            fetchLiveFor(code)
              .then(json => {
                const feat = (json && json.features && json.features[0]) || null;
                const html = feat ? renderProps(feat.properties||{}) : '<em>Geen gegevens gevonden</em>';
                lyr.setPopupContent(`PC4: <strong>${code}</strong><br>${html}`);
              })
              .catch(err => {
                console.error('Live ophalen faalde', err);
                lyr.setPopupContent(`PC4: <strong>${code}</strong><br><em>Live ophalen mislukt</em>`);
              });
          });
        }).addTo(map);
        map.fitBounds(pc4.getBounds().pad(0.05));
        // Haal basisscholen op voor de huidige kaartuitsnede (zodra PC4 geladen is)
        if(!schoolsLoaded){
          schoolsLoaded = true;
          fetchSchoolsFor(pc4.getBounds()).then(renderSchools).catch(e=>console.warn('Basisscholen laden faalde', e));
        }
      })
      .catch(err => {
        console.error('GeoJSON laden mislukt:', err);
        alert('Kon cbs_postcode4_brabant.geojson niet laden. Controleer bestandsnaam/locatie.');
      });
  // (Optioneel) bij ver in-/uitzoomen basisscholen opnieuw ophalen
    map.on('moveend', () => {
      if(!schoolsLoaded) return;
      // Alleen opnieuw laden als de kaart veel verschoven is of zoomniveau flink veranderde; voor nu simpel elke moveend
      fetchSchoolsFor(map.getBounds()).then(renderSchools).catch(()=>{});
    });
  </script>
</body>
</html>
