<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PC4 Postcodes – Leaflet (Single HTML, PDOK fallback)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    :root { --sidebar-width:360px; --bg:#0f172a; --panel:#111827; --muted:#9ca3af; --accent:#22c55e; --border:#1f2937; }
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:#e5e7eb}
    #app{display:grid;grid-template-columns:var(--sidebar-width) 1fr;height:100%}
    #map{width:100%;height:100%}
    .sidebar{background:var(--panel);border-right:1px solid var(--border);padding:12px 14px;overflow:auto}
    .brand{display:flex;align-items:center;gap:10px;font-weight:600;margin-bottom:8px}.brand .dot{width:10px;height:10px;border-radius:9999px;background:var(--accent);box-shadow:0 0 16px var(--accent)}
    .hint{color:var(--muted);font-size:12px;line-height:1.4;margin:8px 0 14px}
    .group{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:12px;background:#0b1220}
    .group h3{margin:0 0 8px;font-size:14px;color:#f3f4f6}
    .row{display:flex;align-items:center;gap:10px;margin:6px 0}
    .row input[type="text"]{flex:1;padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:#0a0f1c;color:#e5e7eb}
    .btn{appearance:none;border:1px solid var(--border);background:#101827;color:#e5e7eb;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:500}
    .kpi{display:flex;gap:8px;flex-wrap:wrap}.kpi .badge{background:#0a0f1c;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    .error{color:#fecaca;background:#2a0b0b;border:1px solid #7f1d1d;padding:8px;border-radius:8px;font-size:12px;display:none}
    .footer{color:var(--muted);font-size:11px;margin-top:6px}
    .color{width:28px;height:28px;padding:0;border-radius:8px;border:1px solid var(--border);background:transparent}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div id="app">
    <aside class="sidebar">
      <div class="brand"><span class="dot"></span><span>PC4 Postcodes (Leaflet)</span></div>
      <div class="hint">Autoload via URL:<br>
        <code>?source=arcgis&url=https://services.arcgis.com/.../FeatureServer/0</code><br>
        <code>?source=wfs&url=https://example.com/geoserver/wfs&typenames=namespace:layer</code><br>
        <code>?source=github&url=https://api.github.com/repos/OWNER/REPO/contents/file.geojson?ref=main</code>
      </div>

      <div class="kpi">
        <div class="badge" id="badge-source">bron: —</div>
        <div class="badge" id="badge-features">features: 0</div>
      </div>

      <div id="err" class="error"></div>

      <div class="group">
        <h3>Weergave</h3>
        <div class="row"><label class="small"><input type="checkbox" id="toggle-borders" checked> Borders aan</label></div>
        <div class="row">
          <label class="small" style="width:90px">Opacity</label>
          <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.5" style="flex:1"/>
          <span id="opacity-val" class="small">0.50</span>
        </div>
      </div>

      <div class="group">
        <h3>Dataset-filter</h3>
        <div class="row">
          <label class="small"><input type="checkbox" id="filter-nb" checked> Filter op Noord-Brabant</label>
        </div>
        <div class="small">Zet uit om eerst álle PC4-polygonen te zien (debug/sanity check).</div>
      </div>

      <div class="group">
        <h3>Zoom naar PC4</h3>
        <div class="row">
          <input type="text" id="pc4-input" placeholder="bijv. 5141" maxlength="4" />
          <button class="btn" id="pc4-btn">Zoom</button>
        </div>
      </div>

      <div class="group">
        <h3>Noord-Brabant selectie</h3>
        <div id="muni-controls"></div>
      </div>

      <div class="footer">Startpositie: URL (lat, lon, zoom) of 51.6938, 5.0844 (zoom 12). Popups tonen PC4 + gemeentenaam.</div>
    </aside>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // Gemeenten & PC4-reeksen
    const MUNICIPALITIES = {
      'Altena': [[4250,4255],[4260,4269],[4270,4273],[4280,4288]],
      'Waalwijk': [[5141,5149]],
      'Heusden': [[5150,5154],[5250,5256]],
      'Loon op Zand': [[5170,5176]],
      'Dongen': [[5100,5109]]
    };
    const DEFAULT_COLORS = { 'Altena':'#22c55e','Waalwijk':'#60a5fa','Heusden':'#f59e0b','Loon op Zand':'#ef4444','Dongen':'#a78bfa' };

    // UI refs
    const errBox = document.getElementById('err');
    const badgeSource = document.getElementById('badge-source');
    const badgeFeatures = document.getElementById('badge-features');
    const opacitySlider = document.getElementById('opacity');
    const opacityVal = document.getElementById('opacity-val');
    const bordersToggle = document.getElementById('toggle-borders');

    // Helpers
    function idForMunicipality(name){ return name.toLowerCase().replace(/\s+/g,'-'); }
    function cssEscape(s){ return String(s).replace(/[^a-zA-Z0-9_-]/g, m => '\\' + m); }

    // Map init (allecijfers-style)
    const params = new URLSearchParams(location.search);
    const startLat = Number.isFinite(parseFloat(params.get('lat'))) ? parseFloat(params.get('lat')) : 51.6938;
    const startLon = Number.isFinite(parseFloat(params.get('lon'))) ? parseFloat(params.get('lon')) : 5.0844;
    const startZoom = Number.isInteger(parseInt(params.get('zoom'),10)) ? parseInt(params.get('zoom'),10) : 12;
    const paramPC4 = (params.get('pc4') || '').match(/\d{4}/)?.[0] || null;

    const map = L.map('map').setView([startLat, startLon], startZoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19,attribution:'&copy; OpenStreetMap-bijdragers'}).addTo(map);

    // Lagen per gemeente
    const layersByMunicipality = {};
    const featureIndexByPC4 = {};
    const makeStyle = (name) => ({
      color: bordersToggle.checked ? '#1f2937' : 'transparent',
      weight: bordersToggle.checked ? 1 : 0,
      fillColor: (() => {
        const id = idForMunicipality(name);
        const picker = document.querySelector(`[data-color-for="${cssEscape(id)}"]`);
        return (picker?.value) || DEFAULT_COLORS[name] || '#22c55e';
      })(),
      fillOpacity: parseFloat(opacitySlider.value)
    });

    for (const muni of Object.keys(MUNICIPALITIES)) {
      layersByMunicipality[muni] = L.geoJSON(null, {
        style: () => makeStyle(muni),
        onEachFeature: (feature, layer) => {
          const pc4 = extractPC4(feature.properties);
          const title = pc4 ? `PC4 ${pc4}` : 'PC4 onbekend';
          layer.bindPopup(`${title} – ${muni}`);
          if (pc4) (featureIndexByPC4[pc4] ||= []).push(layer);
        }
      }).addTo(map);
    }

    // Sidebar controls
    const controlsHost = document.getElementById('muni-controls');
    for (const muni of Object.keys(MUNICIPALITIES)) {
      const id = idForMunicipality(muni);
      const color = DEFAULT_COLORS[muni] || '#22c55e';
      const block = document.createElement('div');
      block.className = 'row';
      block.innerHTML = `
        <label class="small" style="flex:1"><input type="checkbox" checked data-toggle-for="${id}" /> ${muni}</label>
        <input class="color" type="color" value="${color}" data-color-for="${id}" title="Kleur voor ${muni}" />
      `;
      controlsHost.appendChild(block);
      block.querySelector(\`[data-toggle-for="${id}"]\`).addEventListener('change', (e) => {
        const layer = layersByMunicipality[muni];
        if (e.target.checked) layer.addTo(map); else map.removeLayer(layer);
      });
      block.querySelector(\`[data-color-for="${id}"]\`).addEventListener('input', () => {
        layersByMunicipality[muni].setStyle(() => makeStyle(muni));
      });
    }
    bordersToggle.addEventListener('change', applyGlobalStyles);
    opacitySlider.addEventListener('input', () => { opacityVal.textContent = Number(opacitySlider.value).toFixed(2); applyGlobalStyles(); });
    function applyGlobalStyles(){ for (const m of Object.keys(layersByMunicipality)) layersByMunicipality[m].setStyle(() => makeStyle(m)); }

    // Zoom naar PC4
    document.getElementById('pc4-btn').addEventListener('click', () => {
      const raw = document.getElementById('pc4-input').value.trim();
      const pc4 = (raw.match(/\d{4}/) || [null])[0];
      if (!pc4) return alert('Voer 4 cijfers in (PC4).');
      zoomToPC4(pc4);
    });
    function zoomToPC4(pc4){
      const layers = featureIndexByPC4[pc4];
      if (!layers || layers.length===0) { alert(`Geen features gevonden voor PC4 ${pc4}.`); return; }
      let bounds=null; layers.forEach(l=>{const b=l.getBounds?.(); if(b) bounds = bounds? bounds.extend(b): b;});
      if (bounds) map.fitBounds(bounds.pad(0.15));
    }

    // PC4-detectie (breder)
    const PC4_KEYS = [
      'pc4','PC4','pc_4','postcode4','Postcode4','POSTCODE4','postcode','code',
      'PC4_CODE','PC4CODE','pc4code','pc4_code','pc4num','pc4_num','pc4_str','statcode'
    ];
    function extractPC4(props){
      if(!props) return null;
      for (const k of PC4_KEYS){
        if (k in props){ const m = String(props[k]).match(/(\d{4})/); if (m) return m[1]; }
      }
      return null;
    }
    function municipalityFromPC4(pc4){
      const n = Number(pc4);
      for (const [muni,ranges] of Object.entries(MUNICIPALITIES)){
        for (const [a,b] of ranges){ if (n>=a && n<=b) return muni; }
      }
      return null;
    }

    // Autoload bron
    const source = params.get('source'); const url = params.get('url'); const typenames = params.get('typenames');
    if (source && url){
      badgeSource.textContent = `bron: ${source}`;
      autoload(source,url,typenames).then(()=>{ if(paramPC4) zoomToPC4(paramPC4); }).catch(showError);
    } else {
      // PDOK-fallback met autodetectie + BBOX-clip
      (async () => {
        try {
          badgeSource.textContent = 'bron: PDOK WFS (auto)';
          await loadPdokPostcode4Fallback();
          if (paramPC4) zoomToPC4(paramPC4);
        } catch (e) {
          badgeSource.textContent = 'bron: (geen – gebruik ?source=arcgis|wfs|github & url=...)';
          showError(new Error('Geen data geladen via PDOK fallback. Geef een bron via URL-parameters of controleer CORS.'));
        }
      })();
    }

    async function autoload(source, baseUrl, typenames){
      try{
        if (source==='arcgis'){
          const fc = await fetchGeoJSON(buildArcGisQueryUrl(baseUrl));
          await ingestGeoJSON(fc);
        } else if (source==='wfs'){
          if (!typenames) throw new Error('WFS vereist parameter "typenames".');
          const fc = await fetchGeoJSON(buildWFSUrl(baseUrl, typenames));
          await ingestGeoJSON(fc);
        } else if (source==='github'){
          const data = await fetchGithubGeoJSON(baseUrl);
          await ingestGeoJSON(data);
        } else { throw new Error(`Onbekende source: ${source}`); }
      } catch(e){ showError(e); }
    }

    // Helpers voor bronnen
    function buildArcGisQueryUrl(layerUrl){
      const hasQuery = /\/query(\?|$)/.test(layerUrl);
      const base = hasQuery ? layerUrl.replace(/\/query.*$/, '/query') : (layerUrl.replace(/\/$/, '') + '/query');
      const u = new URL(base);
      u.searchParams.set('where','1=1'); u.searchParams.set('outFields','*'); u.searchParams.set('outSR','4326'); u.searchParams.set('f','geojson');
      return u.toString();
    }

    // WFS helpers + PDOK fallback
    function buildWFSUrl(base, typeNames){ return buildWFSUrlWithExtras(base,typeNames,{}); }
    function buildWFSUrlWithExtras(base, typeNames, extras={}){
      const u = new URL(base);
      u.searchParams.set('service','WFS'); u.searchParams.set('version','2.0.0'); u.searchParams.set('request','GetFeature');
      u.searchParams.set('typenames',typeNames); u.searchParams.set('outputFormat','application/json'); u.searchParams.set('srsName','EPSG:4326');
      if (extras.count) u.searchParams.set('count', String(extras.count));
      if (extras.bbox)  u.searchParams.set('bbox', `${extras.bbox},EPSG:4326`); // CRS-suffix verplicht
      return u.toString();
    }
    async function loadPdokPostcode4Fallback(){
      const bases = [
        'https://service.pdok.nl/cbs/postcode4/2024/wfs/v1_0',
        'https://service.pdok.nl/cbs/postcode4/2023/wfs/v1_0'
      ];
      const typeCandidates = ['postcode4','cbs:postcode4','postcode4_2024','cbs:postcode4_2024','postcode4_2023','cbs:postcode4_2023'];

      // bbox uit huidige kaart (lon,lat)
      const b = map.getBounds();
      const bbox = [b.getWest(), b.getSouth(), b.getEast(), b.getNorth()].join(',');

      for (const base of bases){
        for (const tn of typeCandidates){
          try{
            // 1) laag verifiëren zonder bbox
            const probe = await fetchGeoJSON(buildWFSUrlWithExtras(base, tn, {count:1}));
            if (!probe || !Array.isArray(probe.features)) continue;

            // 2) snel laden met bbox
            const urlBbox = buildWFSUrlWithExtras(base, tn, {bbox});
            const fcBbox = await fetchGeoJSON(urlBbox);
            let fc = fcBbox;

            // 3) als bbox niets oplevert, laad alles (fallback)
            if (!fcBbox.features || fcBbox.features.length === 0) {
              const urlAll = buildWFSUrlWithExtras(base, tn, {});
              fc = await fetchGeoJSON(urlAll);
            }

            await ingestGeoJSON(fc);
            console.log(`[PDOK Fallback] OK met ${base} typeNames=${tn}`);
            return;
          } catch {}
        }
      }
      throw new Error('Geen geldige WFS typeNames gevonden op PDOK Postcode4.');
    }

    async function fetchGithubGeoJSON(apiUrl){
      const res = await fetch(apiUrl, { headers:{'Accept':'application/vnd.github+json'} });
      if (!res.ok) throw new Error(`GitHub API fout: ${res.status} ${res.statusText}`);
      const json = await res.json();
      const text = atob(json.content.replace(/\n/g,''));
      return JSON.parse(text);
    }

    async function fetchGeoJSON(url){
      try{
        const res = await fetch(url, { mode:'cors' });
        if (!res.ok) throw new Error(`HTTP ${res.status} bij ophalen van GeoJSON.`);
        const txt = await res.text(); let data;
        try{ data = JSON.parse(txt); } catch{ throw new Error('Antwoord kon niet als JSON worden geparseerd.'); }
        if (!data || (!data.type && !data.features)) throw new Error('Antwoord is geen geldige GeoJSON FeatureCollection.');
        return data;
      } catch(e){
        if (e.name === 'TypeError') throw new Error('Netwerk/CORS fout bij ophalen van data.');
        throw e;
      }
    }

    async function ingestGeoJSON(fc){
      // reset
      for (const m of Object.keys(layersByMunicipality)) layersByMunicipality[m].clearLayers();
      for (const k of Object.keys(featureIndexByPC4)) delete featureIndexByPC4[k];

      const filterNB = document.getElementById('filter-nb')?.checked ?? true;

      let totalLoaded=0, totalDrawn=0;
      for (const f of (fc.features||[])){
        totalLoaded++;
        const pc4 = extractPC4(f.properties); if (!pc4) continue;

        if (filterNB) {
          const muni = municipalityFromPC4(pc4);
          if (!muni) continue;
          layersByMunicipality[muni].addData(f);
        } else {
          // teken alles in 1 layer (maakt kleur niet uit)
          layersByMunicipality['Waalwijk'].addData(f);
        }
        totalDrawn++;
      }

      badgeFeatures.textContent = `features: ${totalDrawn}`;
      console.log(`[PC4 Loader] Bron: ${totalLoaded}, Getekend: ${totalDrawn}, filterNB=${filterNB}`);

      let bounds=null;
      for (const m of Object.keys(layersByMunicipality)){
        const b = layersByMunicipality[m].getBounds?.();
        if (b && b.isValid()) bounds = bounds ? bounds.extend(b) : b;
      }
      if (bounds){
        const explicit = Number.isInteger(parseInt(new URLSearchParams(location.search).get('zoom'),10));
        if (!explicit) map.fitBounds(bounds.pad(0.15));
      }
    }

    function showError(err){ console.error(err); errBox.textContent = `Fout: ${err.message || err}`; errBox.style.display='block'; }
  </script>
</body>
</html>
