<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Postcodekaart (PC4) – Selecteer gebieden en kleur</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    html, body { height: 100%; margin: 0; }
    #app { display: grid; grid-template-columns: 320px 1fr; height: 100%; }
    #sidebar { padding: 12px; border-right: 1px solid #eee; overflow: auto; }
    #map { height: 100%; width: 100%; }
    .block { margin-bottom: 16px; }
    .layer-row { display: flex; align-items: center; gap: 8px; margin: 8px 0; }
    .hint { font-size: 12px; color: #555; }
    fieldset { border: 1px solid #eee; border-radius: 12px; padding: 10px 12px; }
    legend { padding: 0 6px; font-weight: 600; }
    .badge { display:inline-block; padding:2px 6px; border-radius:8px; background:#f5f5f5; font-size: 12px; }
  </style>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <h2 style="margin-top:0">Postcodekaart (PC4)</h2>
    <p class="hint">Je kunt een <strong>pc4.geojson</strong> lokaal kiezen of via een <strong>URL</strong> laden. Het bestand moet per vlak een property met de PC4 bevatten, bv. <code>pc4</code>, <code>PC4</code>, <code>postcode4</code> of <code>postcode</code>.</p>

    <div class="block">
      <fieldset>
        <legend>Data laden (extern, geen upload nodig)</legend>
        <div class="layer-row" style="align-items: stretch;">
          <select id="sourceType" style="padding:6px 8px;border-radius:8px;border:1px solid #ddd">
            <option value="arcgis">ArcGIS FeatureServer</option>
            <option value="wfs">WFS (OGC)</option>
            <option value="github">GitHub API (public repo)</option>
            <option value="raw">Rechtstreekse GeoJSON URL</option>
          </select>
        </div>
        <div id="src_arcgis">
          <div class="layer-row" style="align-items: stretch;">
            <input id="arcgisUrl" placeholder="https://<host>/.../FeatureServer/0 (laag-URL)" style="flex:1;padding:6px 8px;border-radius:8px;border:1px solid #ddd" />
            <button id="loadArcgisBtn">Laden via ArcGIS</button>
          </div>
          <p class="hint">We voegen automatisch <code>/query?where=1%3D1&outFields=*&outSR=4326&f=geojson</code> toe en laden alle features. Vaak staat CORS hier al goed.</p>
        </div>
        <div id="src_wfs" style="display:none">
          <div class="layer-row" style="align-items: stretch;">
            <input id="wfsBase" placeholder="https://<host>/geoserver/<workspace>/wfs" style="flex:1;padding:6px 8px;border-radius:8px;border:1px solid #ddd" />
          </div>
          <div class="layer-row" style="align-items: stretch;">
            <input id="wfsTypeName" placeholder="<workspace>:<laagnaam> (typenames)" style="flex:1;padding:6px 8px;border-radius:8px;border:1px solid #ddd" />
            <button id="loadWfsBtn">Laden via WFS</button>
          </div>
          <p class="hint">We gebruiken <code>GetFeature</code> met <code>outputFormat=application/json</code> en <code>srsName=EPSG:4326</code>.</p>
        </div>
        <div id="src_github" style="display:none">
          <div class="layer-row" style="align-items: stretch;">
            <input id="ghOwner" placeholder="owner (bijv. barmando)" style="flex:1;padding:6px 8px;border-radius:8px;border:1px solid #ddd" />
            <input id="ghRepo" placeholder="repo (bijv. postcode)" style="flex:1;padding:6px 8px;border-radius:8px;border:1px solid #ddd" />
          </div>
          <div class="layer-row" style="align-items: stretch;">
            <input id="ghPath" placeholder="pad in repo (bijv. pc4.geojson)" style="flex:1;padding:6px 8px;border-radius:8px;border:1px solid #ddd" />
            <input id="ghRef" placeholder="ref (bijv. main)" style="width:160px;padding:6px 8px;border-radius:8px;border:1px solid #ddd" />
            <button id="loadGhBtn">Laden via GitHub API</button>
          </div>
          <p class="hint">Werkt cross-origin. De API geeft Base64 terug; de app decodeert en leest het als GeoJSON.</p>
        </div>
        <div id="src_raw" style="display:none">
          <div class="layer-row" style="align-items: stretch;">
            <input id="geoUrl" placeholder="https://.../pc4.geojson (rechtstreekse GeoJSON)" style="flex:1;padding:6px 8px;border-radius:8px;border:1px solid #ddd" />
            <button id="loadUrlBtn">Laden via URL</button>
          </div>
          <p class="hint">De server moet <em>CORS</em> toestaan.</p>
        </div>
    </div>

    <div class="block">
      <fieldset>
        <legend>Kaartlaag opties</legend>
        <label class="layer-row">
          <input type="checkbox" id="showBorders" checked>
          <span>Toon randen</span>
        </label>
        <label class="layer-row">
          Opacity
          <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.5" />
          <span id="opacityVal" class="badge">0.50</span>
        </label>
      </fieldset>
    </div>

    <div class="block">
      <fieldset>
        <legend>Selecties per gemeente</legend>
        <div id="municipalityControls"></div>
      </fieldset>
      <p class="hint">Gemeenten/gebieden (PC4-reeksen) gebaseerd op jouw lijst: Altena, Waalwijk, Heusden, Loon op Zand, Dongen.</p>
    </div>

    <div class="block">
      <fieldset>
        <legend>Zoek PC4</legend>
        <div class="layer-row">
          <input id="pc4Search" placeholder="Bijv. 5144" style="flex:1;padding:6px 8px;border-radius:8px;border:1px solid #ddd" />
          <button id="zoomBtn">Zoom</button>
        </div>
        <p class="hint">Zoom naar een specifiek PC4-gebied (exacte 4 cijfers).</p>
      </fieldset>
    </div>

    <div class="block hint">
      <details>
        <summary>Tips</summary>
        <ul>
          <li>Wil je een extra gemeente of reeks toevoegen? Pas de <code>MUNICIPALITIES</code>-config in de code aan.</li>
          <li>Je kunt randen uitzetten of de transparantie aanpassen om overlappende vlakken beter te zien.</li>
        </ul>
      </details>
    </div>
  </aside>
  <main id="map"></main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
// --- Configuratie ---
const MUNICIPALITIES = {
  "Altena": {
    ranges: [[4250,4255],[4260,4269],[4270,4273],[4280,4288]],
    color: "#e74c3c"
  },
  "Waalwijk": {
    ranges: [[5141,5149]],
    color: "#3498db"
  },
  "Heusden": {
    ranges: [[5150,5154],[5250,5256]],
    color: "#2ecc71"
  },
  "Loon op Zand": {
    ranges: [[5170,5176]],
    color: "#9b59b6"
  },
  "Dongen": {
    ranges: [[5100,5109]],
    color: "#f1c40f"
  }
};

// Kaart op jouw coördinaten
const map = L.map('map').setView([51.6938, 5.0844], 12);

// Basislaag
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap-bijdragers'
}).addTo(map);

// Opslag voor alle PC4 features
let allFeatures = [];
let indexByPc4 = new Map(); // pc4 string -> Leaflet layer

// Per gemeente een layergroup om later te kunnen togglen
const municipalityLayers = {};
Object.keys(MUNICIPALITIES).forEach(name => {
  municipalityLayers[name] = L.geoJSON([], {
    style: f => ({
      color: document.getElementById('showBorders')?.checked ? '#222' : 'transparent',
      weight: 1,
      fillColor: MUNICIPALITIES[name].color,
      fillOpacity: parseFloat(document.getElementById('opacity')?.value || '0.5')
    }),
    onEachFeature: (feature, layer) => {
      const pc4 = getPc4(feature);
      layer.bindPopup(`<strong>PC4:</strong> ${pc4 || '(onbekend)'}<br/><strong>Gemeente:</strong> ${name}`);
    }
  }).addTo(map);
});

// UI voor gemeenten genereren
const controlsDiv = document.getElementById('municipalityControls');
const checkboxByMunicipality = new Map();
const colorInputByMunicipality = new Map();
Object.entries(MUNICIPALITIES).forEach(([name, cfg], i) => {
  const row = document.createElement('div');
  row.className = 'layer-row';

  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.id = `chk_${i}`;

  const label = document.createElement('label');
  label.htmlFor = checkbox.id;
  label.textContent = name;

  const color = document.createElement('input');
  color.type = 'color';
  color.value = cfg.color;
  color.title = `Kleur voor ${name}`;

  row.appendChild(checkbox);
  row.appendChild(label);
  row.appendChild(color);
  controlsDiv.appendChild(row);

  checkboxByMunicipality.set(name, checkbox);
  colorInputByMunicipality.set(name, color);

  checkbox.addEventListener('change', () => {
    cfg.enabled = checkbox.checked;
    cfg.color = color.value;
    renderMunicipality(name);
  });
  color.addEventListener('input', () => {
    cfg.color = color.value;
    // werk stijl bij
    municipalityLayers[name].setStyle({ fillColor: cfg.color });
  });
});

// --- Eenvoudige JS "API" om dit van buitenaf aan te roepen ---
window.pc4App = {
  setEnabled(name, enabled = true) {
    const cfg = MUNICIPALITIES[name];
    if (!cfg) return false;
    cfg.enabled = !!enabled;
    const cb = checkboxByMunicipality.get(name);
    if (cb) cb.checked = cfg.enabled;
    renderMunicipality(name);
    return true;
  },
  setColor(name, color) {
    const cfg = MUNICIPALITIES[name];
    if (!cfg || !/^#?[0-9a-fA-F]{6}$/.test(color)) return false;
    const hex = color.startsWith('#') ? color : `#${color}`;
    cfg.color = hex;
    const ci = colorInputByMunicipality.get(name);
    if (ci) ci.value = hex;
    municipalityLayers[name].setStyle({ fillColor: hex });
    return true;
  },
  setOpacity(val) {
    const v = Math.max(0, Math.min(1, Number(val)));
    opacityInput.value = String(v);
    opacityVal.textContent = v.toFixed(2);
    for (const layer of Object.values(municipalityLayers)) {
      layer.setStyle({ fillOpacity: v });
    }
  },
  setBorders(show) {
    const s = !!show;
    document.getElementById('showBorders').checked = s;
    for (const layer of Object.values(municipalityLayers)) {
      layer.setStyle({ color: s ? '#222' : 'transparent' });
    }
  },
  zoomToPc4(pc4) {
    const layer = indexByPc4.get(String(pc4));
    if (!layer) return false;
    map.fitBounds(layer.getBounds(), { padding: [20,20] });
    return true;
  },
  enableMany(items) {
    // items: [{ name: 'Altena', enabled: true, color: '#ff0000' }, ...]
    items.forEach(({name, enabled, color}) => {
      if (typeof enabled === 'boolean') this.setEnabled(name, enabled);
      if (typeof color === 'string') this.setColor(name, color);
    });
  }
};

// URL-parameters ondersteunen: ?mun=Altena,Waalwijk&colors=Altena:#ff0000;Waalwijk:#00ff00&pc4=5144
(function applyUrlParams(){
  const sp = new URLSearchParams(location.search);
  const mun = sp.get('mun');
  const colors = sp.get('colors');
  const pc4 = sp.get('pc4');

  if (colors) {
    colors.split(';').forEach(pair => {
      const [nm, col] = pair.split(':');
      if (nm && col) window.pc4App.setColor(nm.trim(), col.trim());
    });
  }
  if (mun) {
    mun.split(',').forEach(nm => window.pc4App.setEnabled(nm.trim(), true));
  }
  if (pc4) {
    // wacht heel even tot indexByPc4 gevuld is
    const tryZoom = () => {
      if (indexByPc4.size === 0) return setTimeout(tryZoom, 100);
      window.pc4App.zoomToPc4(pc4.trim());
    };
    tryZoom();
  }
})();

// Opacity & randen
const opacityInput = document.getElementById('opacity');
const opacityVal = document.getElementById('opacityVal');
opacityInput.addEventListener('input', () => {
  const v = parseFloat(opacityInput.value);
  opacityVal.textContent = v.toFixed(2);
  for (const layer of Object.values(municipalityLayers)) {
    layer.setStyle({ fillOpacity: v });
  }
});

document.getElementById('showBorders').addEventListener('change', (e) => {
  const show = e.target.checked;
  for (const layer of Object.values(municipalityLayers)) {
    layer.setStyle({ color: show ? '#222' : 'transparent' });
  }
});

// Zoeken en zoomen naar een PC4
const pc4Input = document.getElementById('pc4Search');
document.getElementById('zoomBtn').addEventListener('click', () => {
  const val = (pc4Input.value || '').trim();
  if (!/^\d{4}$/.test(val)) return alert('Voer een geldige PC4 in (4 cijfers).');
  const layer = indexByPc4.get(val);
  if (layer) {
    map.fitBounds(layer.getBounds(), { padding: [20,20] });
    layer.openPopup();
  } else {
    alert(`PC4 ${val} niet gevonden (zorg dat pc4.geojson geladen is).`);
  }
});

// GeoJSON laden (extern, geen upload nodig)
async function applyGeojson(geo) {
  allFeatures = geo && geo.type === 'FeatureCollection' ? geo.features : [];
  indexByPc4 = new Map();
  allFeatures.forEach(f => {
    const pc4 = getPc4(f);
    if (!pc4) return;
    const lyr = L.geoJSON(f);
    indexByPc4.set(String(pc4), lyr);
  });
  Object.keys(MUNICIPALITIES).forEach(name => renderMunicipality(name));
}

async function loadFromArcgis(baseUrl) {
  const clean = baseUrl.split('?')[0].replace(/\/$/, '');
  const url = `${clean}/query?where=1%3D1&outFields=*&outSR=4326&f=geojson`;
  try {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const geo = await r.json();
    await applyGeojson(geo);
    alert('GeoJSON geladen via ArcGIS FeatureServer.');
  } catch (err) {
    console.error('ArcGIS load error:', err);
    alert('Laden via ArcGIS mislukt. Controleer de service-URL of CORS.');
  }
}

async function loadFromWfs(base, typeName) {
  const params = new URLSearchParams({
    service: 'WFS', version: '2.0.0', request: 'GetFeature',
    typename: typeName, // sommige servers gebruiken typenames, andere typename
    typenames: typeName,
    srsName: 'EPSG:4326', outputFormat: 'application/json'
  });
  const url = `${base}?${params.toString()}`;
  try {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const geo = await r.json();
    await applyGeojson(geo);
    alert('GeoJSON geladen via WFS.');
  } catch (err) {
    console.error('WFS load error:', err);
    alert('Laden via WFS mislukt. Controleer de URL/typenames of CORS.');
  }
}

async function loadFromGitHub(owner, repo, path, ref='main') {
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${encodeURIComponent(ref)}`;
  try {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();
    const text = atob(String(j.content || '').replace(/\n/g, ''));
    const geo = JSON.parse(text);
    await applyGeojson(geo);
    alert('GeoJSON geladen via GitHub API.');
  } catch (err) {
    console.error('GitHub API load error:', err);
    alert('Laden via GitHub API mislukt. Controleer owner/repo/path en dat het bestand publiek is.');
  }
}

async function loadFromUrl(url) {
  try {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const geo = await r.json();
    await applyGeojson(geo);
    alert('GeoJSON geladen van URL.');
  } catch (err) {
    console.error('URL load error:', err);
    alert('Laden via URL mislukt. Controleer de URL en CORS-instellingen.');
  }
}

// UI events voor laden
const sourceTypeSel = document.getElementById('sourceType');
const arcgisDiv = document.getElementById('src_arcgis');
const wfsDiv = document.getElementById('src_wfs');
const ghDiv = document.getElementById('src_github');
const rawDiv = document.getElementById('src_raw');

sourceTypeSel.addEventListener('change', () => {
  const v = sourceTypeSel.value;
  arcgisDiv.style.display = v === 'arcgis' ? '' : 'none';
  wfsDiv.style.display = v === 'wfs' ? '' : 'none';
  ghDiv.style.display = v === 'github' ? '' : 'none';
  rawDiv.style.display = v === 'raw' ? '' : 'none';
});

const loadArcgisBtn = document.getElementById('loadArcgisBtn');
const arcgisUrl = document.getElementById('arcgisUrl');
const loadWfsBtn = document.getElementById('loadWfsBtn');
const wfsBase = document.getElementById('wfsBase');
const wfsTypeName = document.getElementById('wfsTypeName');
const loadGhBtn = document.getElementById('loadGhBtn');
const ghOwner = document.getElementById('ghOwner');
const ghRepo = document.getElementById('ghRepo');
const ghPath = document.getElementById('ghPath');
const ghRef = document.getElementById('ghRef');
const loadUrlBtn = document.getElementById('loadUrlBtn');
const geoUrl = document.getElementById('geoUrl');

loadArcgisBtn?.addEventListener('click', () => {
  const url = (arcgisUrl.value || '').trim();
  if (!url) return alert('Voer eerst een ArcGIS FeatureServer-laag-URL in.');
  loadFromArcgis(url);
});

loadWfsBtn?.addEventListener('click', () => {
  const base = (wfsBase.value || '').trim();
  const tn = (wfsTypeName.value || '').trim();
  if (!base || !tn) return alert('Vul WFS base en typenames in.');
  loadFromWfs(base, tn);
});

loadGhBtn?.addEventListener('click', () => {
  const owner = (ghOwner.value || '').trim();
  const repo = (ghRepo.value || '').trim();
  const path = (ghPath.value || '').trim();
  const ref = (ghRef.value || 'main').trim();
  if (!owner || !repo || !path) return alert('Vul owner, repo en path in.');
  loadFromGitHub(owner, repo, path, ref);
});

loadUrlBtn?.addEventListener('click', () => {
  const url = (geoUrl.value || '').trim();
  if (!url) return alert('Voer eerst een URL in.');
  loadFromUrl(url);
});

// Auto-load via URL parameters, bv. ?source=arcgis&url=<...>
(function autoloadFromQuery(){
  const sp = new URLSearchParams(location.search);
  const src = sp.get('source');
  const url = sp.get('url');
  const owner = sp

// Probeer standaard pc4.geojson uit dezelfde map te laden (optioneel)
fetch('pc4.geojson')
  .then(r => r.ok ? r.json() : Promise.reject(r.status))
  .then(applyGeojson)
  .catch(() => console.info('Geen pc4.geojson gevonden in dezelfde map (niet erg).'));

// Helpers
function getPc4(feature) {
  // Probeer verschillende property-namen
  const p = feature.properties || {};
  let v = p.pc4 ?? p.PC4 ?? p.pc_4 ?? p.postcode4 ?? p.postcode ?? p.code;
  if (v == null) return null;
  v = String(v).trim();
  // haal eventueel extra tekens weg (bijv. "5144 AB" -> "5144")
  const m = v.match(/(\d{4})/);
  return m ? m[1] : null;
}

function inRanges(pc4, ranges) {
  const n = parseInt(pc4, 10);
  if (Number.isNaN(n)) return false;
  return ranges.some(([a,b]) => n >= a && n <= b);
}

function renderMunicipality(name) {
  const cfg = MUNICIPALITIES[name];
  const layer = municipalityLayers[name];
  layer.clearLayers();
  if (!cfg.enabled || allFeatures.length === 0) return;

  // Filter features die in de opgegeven reeksen vallen
  const wanted = allFeatures.filter(f => {
    const pc4 = getPc4(f);
    return pc4 && inRanges(pc4, cfg.ranges);
  });

  layer.addData(wanted);
  layer.setStyle({ fillColor: cfg.color });
}
</script>
</body>
</html>
