<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PC4 Postcodes – Leaflet (Single HTML, PDOK fallback)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    :root {
      --sidebar-width: 360px;
      --bg: #0f172a;          /* slate-900 */
      --panel: #111827;       /* gray-900 */
      --muted: #9ca3af;       /* gray-400 */
      --accent: #22c55e;      /* green-500 */
      --border: #1f2937;      /* gray-800 */
    }
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: #e5e7eb; }
    #app { display: grid; grid-template-columns: var(--sidebar-width) 1fr; height: 100%; }
    #map { width: 100%; height: 100%; }
    .sidebar { background: var(--panel); border-right: 1px solid var(--border); padding: 12px 14px; overflow: auto; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:600; margin-bottom: 8px; }
    .brand .dot { width:10px; height:10px; border-radius: 9999px; background: var(--accent); box-shadow: 0 0 16px var(--accent); }
    .hint { color: var(--muted); font-size: 12px; line-height: 1.4; margin: 8px 0 14px; }
    .group { border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin-bottom: 12px; background: #0b1220; }
    .group h3 { margin: 0 0 8px; font-size: 14px; color:#f3f4f6; }
    .row { display:flex; align-items:center; gap: 10px; margin: 6px 0; }
    .row label { font-size: 13px; }
    .row input[type="text"] { flex: 1; padding: 6px 8px; border-radius: 8px; border: 1px solid var(--border); background: #0a0f1c; color: #e5e7eb; }
    .row input[type="range"] { width: 100%; }
    .btn { appearance: none; border: 1px solid var(--border); background: #101827; color: #e5e7eb; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-weight: 500; }
    .btn:hover { border-color: #374151; }
    .kpi { display:flex; gap:8px; flex-wrap: wrap; }
    .kpi .badge { background:#0a0f1c; border:1px solid var(--border); padding:4px 8px; border-radius: 999px; font-size: 12px; color: var(--muted); }
    .error { color: #fecaca; background:#2a0b0b; border:1px solid #7f1d1d; padding:8px; border-radius:8px; font-size: 12px; display:none; }
    .footer { color: var(--muted); font-size: 11px; margin-top: 6px; }
    .color { width: 28px; height: 28px; padding:0; border-radius: 8px; border: 1px solid var(--border); background: transparent; }
    .flex-1 { flex:1; }
    .small { font-size:12px; color: var(--muted); }
  </style>
</head>
<body>
  <div id="app">
    <aside class="sidebar">
      <div class="brand"><span class="dot"></span> <span>PC4 Postcodes (Leaflet)</span></div>
      <div class="hint">Autoload via URL, bijv.:<br>
        <code>?source=arcgis&url=https://services.arcgis.com/.../FeatureServer/0</code><br>
        <code>?source=wfs&url=https://example.com/geoserver/wfs&typenames=namespace:layer</code><br>
        <code>?source=github&url=https://api.github.com/repos/OWNER/REPO/contents/path/to/file.geojson?ref=main</code>
      </div>

      <div id="status" class="kpi">
        <div class="badge" id="badge-source">bron: —</div>
        <div class="badge" id="badge-features">features: 0</div>
      </div>

      <div id="err" class="error"></div>

      <div class="group">
        <h3>Weergave</h3>
        <div class="row"><label class="flex-1"><input type="checkbox" id="toggle-borders" checked> Borders aan</label></div>
        <div class="row">
          <label class="small" style="width:90px">Opacity</label>
          <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.5" class="flex-1"/>
          <span id="opacity-val" class="small">0.50</span>
        </div>
      </div>

      <div class="group">
        <h3>Zoom naar PC4</h3>
        <div class="row">
          <input type="text" id="pc4-input" placeholder="bijv. 5141" maxlength="4" />
          <button class="btn" id="pc4-btn">Zoom</button>
        </div>
      </div>

      <div class="group">
        <h3>Noord-Brabant selectie</h3>
        <div id="muni-controls"></div>
      </div>

      <div class="footer">Startpositie: via URL-params (lat, lon, zoom) of standaard 51.6938, 5.0844 (zoom 12). Popups tonen PC4 + gemeentenaam. Kleuren & zichtbaarheid zijn live aanpasbaar.</div>
    </aside>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // --- Config: gemeenten & PC4-reeksen ---
    const MUNICIPALITIES = {
      'Altena': [[4250,4255],[4260,4269],[4270,4273],[4280,4288]],
      'Waalwijk': [[5141,5149]],
      'Heusden': [[5150,5154],[5250,5256]],
      'Loon op Zand': [[5170,5176]],
      'Dongen': [[5100,5109]]
    };
    const DEFAULT_COLORS = {
      'Altena': '#22c55e','Waalwijk': '#60a5fa','Heusden': '#f59e0b','Loon op Zand': '#ef4444','Dongen': '#a78bfa'
    };

    // UI refs
    const errBox = document.getElementById('err');
    const badgeSource = document.getElementById('badge-source');
    const badgeFeatures = document.getElementById('badge-features');
    const opacitySlider = document.getElementById('opacity');
    const opacityVal = document.getElementById('opacity-val');
    const bordersToggle = document.getElementById('toggle-borders');

    // Helpers
    function idForMunicipality(name){ return name.toLowerCase().replace(/\s+/g,'-'); }
    function cssEscape(s) { return String(s).replace(/[^a-zA-Z0-9_-]/g, m => '\\' + m); }

    // --- Kaart init (allecijfers-compatibele URL-params) ---
    const params = new URLSearchParams(location.search);
    const pLat = parseFloat(params.get('lat'));
    const pLon = parseFloat(params.get('lon'));
    const pZoom = parseInt(params.get('zoom'), 10);
    const startLat = isFinite(pLat) ? pLat : 51.6938;
    const startLon = isFinite(pLon) ? pLon : 5.0844;
    const startZoom = Number.isInteger(pZoom) ? pZoom : 12;
    const map = L.map('map').setView([startLat, startLon], startZoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap-bijdragers'
    }).addTo(map);

    // Lagen per gemeente
    const layersByMunicipality = {};
    const featureIndexByPC4 = {};

    const makeStyle = (name) => ({
      color: bordersToggle.checked ? '#1f2937' : 'transparent',
      weight: bordersToggle.checked ? 1 : 0,
      fillColor: (() => {
        const id = idForMunicipality(name);
        const picker = document.querySelector(`[data-color-for="${cssEscape(id)}"]`);
        return (picker?.value) || DEFAULT_COLORS[name] || '#22c55e';
      })(),
      fillOpacity: parseFloat(opacitySlider.value)
    });

    for (const muni of Object.keys(MUNICIPALITIES)) {
      layersByMunicipality[muni] = L.geoJSON(null, {
        style: () => makeStyle(muni),
        onEachFeature: (feature, layer) => {
          const pc4 = extractPC4(feature.properties);
          const title = pc4 ? `PC4 ${pc4}` : 'PC4 onbekend';
          layer.bindPopup(`${title} – ${muni}`);
          if (pc4) {
            if (!featureIndexByPC4[pc4]) featureIndexByPC4[pc4] = [];
            featureIndexByPC4[pc4].push(layer);
          }
        }
      }).addTo(map);
    }

    // Sidebar controls
    const controlsHost = document.getElementById('muni-controls');
    for (const muni of Object.keys(MUNICIPALITIES)) {
      const id = idForMunicipality(muni);
      const color = DEFAULT_COLORS[muni] || '#22c55e';
      const block = document.createElement('div');
      block.className = 'row';
      block.innerHTML = `
        <label class="flex-1"><input type="checkbox" checked data-toggle-for="${id}" /> ${muni}</label>
        <input class="color" type="color" value="${color}" data-color-for="${id}" title="Kleur voor ${muni}" />
      `;
      controlsHost.appendChild(block);

      block.querySelector(\`[data-toggle-for="${id}"]\`).addEventListener('change', (e) => {
        const checked = e.target.checked;
        const layer = layersByMunicipality[muni];
        if (!layer) return;
        if (checked) { layer.addTo(map); } else { map.removeLayer(layer); }
      });
      block.querySelector(\`[data-color-for="${id}"]\`).addEventListener('input', () => {
        layersByMunicipality[muni].setStyle(() => makeStyle(muni));
      });
    }
    bordersToggle.addEventListener('change', applyGlobalStyles);
    opacitySlider.addEventListener('input', () => {
      opacityVal.textContent = Number(opacitySlider.value).toFixed(2);
      applyGlobalStyles();
    });
    function applyGlobalStyles() {
      for (const muni of Object.keys(layersByMunicipality)) {
        layersByMunicipality[muni].setStyle(() => makeStyle(muni));
      }
    }

    // Zoom naar PC4
    document.getElementById('pc4-btn').addEventListener('click', () => {
      const raw = document.getElementById('pc4-input').value.trim();
      const pc4 = (raw.match(/\d{4}/) || [null])[0];
      if (!pc4) return alert('Voer 4 cijfers in (PC4).');
      zoomToPC4(pc4);
    });
    function zoomToPC4(pc4) {
      const layers = featureIndexByPC4[pc4];
      if (!layers || layers.length === 0) { alert(\`Geen features gevonden voor PC4 ${pc4}.\`); return; }
      let bounds = null;
      layers.forEach(l => { const b = l.getBounds?.(); if (b) bounds = bounds ? bounds.extend(b) : b; });
      if (bounds) map.fitBounds(bounds.pad(0.15));
    }

    // PC4 detectie
    const PC4_KEYS = ['pc4','PC4','pc_4','postcode4','Postcode4','POSTCODE4','postcode','code','PC4_CODE','PC4CODE','pc4code'];
    function extractPC4(props) {
      if (!props) return null;
      for (const k of PC4_KEYS) {
        if (k in props) {
          const val = props[k]; if (val == null) continue;
          const m = String(val).match(/(\d{4})/);
          if (m) return m[1];
        }
      }
      return null;
    }
    function municipalityFromPC4(pc4) {
      const n = Number(pc4);
      for (const [muni, ranges] of Object.entries(MUNICIPALITIES)) {
        for (const [a,b] of ranges) { if (n >= a && n <= b) return muni; }
      }
      return null;
    }

    // URL params (bron)
    const source = params.get('source');
    const url = params.get('url');
    const typenames = params.get('typenames'); // voor WFS
    const paramPC4 = (params.get('pc4') || '').match(/\d{4}/)?.[0] || null;

    if (source && url) {
      badgeSource.textContent = `bron: ${source}`;
      autoload(source, url, typenames)
        .then(() => { if (paramPC4) zoomToPC4(paramPC4); })
        .catch(showError);
    } else {
      (async () => {
        try {
          badgeSource.textContent = 'bron: PDOK WFS (auto)';
          await loadPdokPostcode4Fallback();
          if (paramPC4) zoomToPC4(paramPC4);
        } catch (e) {
          badgeSource.textContent = 'bron: (geen – gebruik ?source=arcgis|wfs|github & url=...)';
          showError(new Error('Geen data geladen via PDOK fallback. Geef een bron via URL-parameters of controleer CORS.'));
        }
      })();
    }

    async function autoload(source, baseUrl, typenames) {
      try {
        let fetchUrl = '';
        if (source === 'arcgis') {
          fetchUrl = buildArcGisQueryUrl(baseUrl);
          const fc = await fetchGeoJSON(fetchUrl);
          await ingestGeoJSON(fc);
          return;
        } else if (source === 'wfs') {
          if (!typenames) throw new Error('WFS vereist parameter "typenames".');
          fetchUrl = buildWFSUrl(baseUrl, typenames);
          const fc = await fetchGeoJSON(fetchUrl);
          await ingestGeoJSON(fc);
          return;
        } else if (source === 'github') {
          const data = await fetchGithubGeoJSON(baseUrl);
          await ingestGeoJSON(data);
          return;
        } else {
          throw new Error(`Onbekende source: ${source}`);
        }
      } catch (e) { showError(e); }
    }

    function buildArcGisQueryUrl(layerUrl) {
      const hasQuery = /\/query(\?|$)/.test(layerUrl);
      const base = hasQuery ? layerUrl.replace(/\/query.*$/, '/query') : (layerUrl.replace(/\/$/, '') + '/query');
      const url = new URL(base);
      url.searchParams.set('where', '1=1');
      url.searchParams.set('outFields', '*');
      url.searchParams.set('outSR', '4326');
      url.searchParams.set('f', 'geojson');
      return url.toString();
    }

    // WFS helpers + PDOK fallback
    function buildWFSUrl(base, typeNames) {
      return buildWFSUrlWithExtras(base, typeNames, {});
    }
    function buildWFSUrlWithExtras(base, typeNames, extras = {}) {
      const u = new URL(base);
      u.searchParams.set('service', 'WFS');
      u.searchParams.set('version', '2.0.0');
      u.searchParams.set('request', 'GetFeature');
      u.searchParams.set('typenames', typeNames);
      u.searchParams.set('outputFormat', 'application/json');
      u.searchParams.set('srsName', 'EPSG:4326');
      if (extras.count) u.searchParams.set('count', String(extras.count));
      if (extras.bbox) u.searchParams.set('bbox', extras.bbox); // minX,minY,maxX,maxY
      return u.toString();
    }
    async function loadPdokPostcode4Fallback() {
      const bases = [
        'https://service.pdok.nl/cbs/postcode4/2024/wfs/v1_0',
        'https://service.pdok.nl/cbs/postcode4/2023/wfs/v1_0'
      ];
      const typeCandidates = [
        'postcode4','cbs:postcode4','postcode4_2024','cbs:postcode4_2024','postcode4_2023','cbs:postcode4_2023'
      ];
      const b = map.getBounds();
      const bbox = [b.getWest(), b.getSouth(), b.getEast(), b.getNorth()].join(',');

      for (const base of bases) {
        for (const tn of typeCandidates) {
          try {
            const testUrl = buildWFSUrlWithExtras(base, tn, { count: 1, bbox });
            const testFc = await fetchGeoJSON(testUrl);
            if (!testFc || !Array.isArray(testFc.features)) continue;

            const url = buildWFSUrlWithExtras(base, tn, { bbox });
            const fc = await fetchGeoJSON(url);
            await ingestGeoJSON(fc);
            console.log(`[PDOK Fallback] Gelukt met ${base} typeNames=${tn}`);
            return;
          } catch { /* probeer volgende */ }
        }
      }
      throw new Error('Geen geldige WFS typeNames gevonden op PDOK Postcode4.');
    }

    async function fetchGithubGeoJSON(apiUrl) {
      try {
        const res = await fetch(apiUrl, { headers: { 'Accept': 'application/vnd.github+json' } });
        if (!res.ok) throw new Error(`GitHub API fout: ${res.status} ${res.statusText}`);
        const json = await res.json();
        if (!json.content) throw new Error('Ongeldig GitHub API antwoord (geen content).');
        const text = atob(json.content.replace(/\n/g, ''));
        return JSON.parse(text);
      } catch (e) { throw new Error(`GitHub laden mislukt: ${e.message}`); }
    }

    async function fetchGeoJSON(u) {
      try {
        const res = await fetch(u, { mode: 'cors' });
        if (!res.ok) throw new Error(`HTTP ${res.status} bij ophalen van GeoJSON.`);
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch(_) { throw new Error('Antwoord kon niet als JSON worden geparseerd.'); }
        if (!data || (!data.type && !data.features)) throw new Error('Antwoord is geen geldige GeoJSON FeatureCollection.');
        return data;
      } catch (e) {
        if (e.name === 'TypeError') {
          throw new Error('Netwerk/CORS fout bij ophalen van data. Controleer CORS-instellingen of gebruik een CORS-vriendelijke endpoint.');
        }
        throw e;
      }
    }

    async function ingestGeoJSON(fc) {
      for (const muni of Object.keys(layersByMunicipality)) layersByMunicipality[muni].clearLayers();
      for (const k of Object.keys(featureIndexByPC4)) delete featureIndexByPC4[k];

      let total = 0;
      const feats = fc.features || [];
      for (const f of feats) {
        const pc4 = extractPC4(f.properties);
        if (!pc4) continue;
        const muni = municipalityFromPC4(pc4);
        if (!muni) continue;
        layersByMunicipality[muni].addData(f);
        total++;
      }
      badgeFeatures.textContent = `features: ${total}`;
      console.log(`[PC4 Loader] Ingeladen features: ${total}`);

      let bounds = null;
      for (const muni of Object.keys(layersByMunicipality)) {
        const layer = layersByMunicipality[muni];
        if (!map.hasLayer(layer)) continue;
        const b = layer.getBounds?.();
        if (b && b.isValid()) bounds = bounds ? bounds.extend(b) : b;
      }
      if (bounds) {
        const hasExplicitZoom = Number.isInteger(parseInt(new URLSearchParams(location.search).get('zoom'),10));
        if (!hasExplicitZoom) map.fitBounds(bounds.pad(0.15));
      }
    }

    function showError(err) {
      console.error(err);
      errBox.textContent = `Fout: ${err.message || err}`;
      errBox.style.display = 'block';
    }
  </script>
</body>
</html>
